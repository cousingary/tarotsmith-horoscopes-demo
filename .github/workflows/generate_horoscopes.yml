# generate_horoscopes.yml
# -----------------------
# Triggers every Monday at 11:00 AM Bangkok time (04:00 UTC).
# Runs the generation pipeline, commits output JSON to repo.
#
# Full workflow not included in this public mirror.
# See README for pipeline architecture documentation.

name: Generate Weekly Horoscopes

on:
  schedule:
    - cron: '0 4 * * 1'
  workflow_dispatch:
    inputs:
      week:
        description: 'Specific week_start to run (YYYY-MM-DD)'
        required: false
        default: ''
      dry_run:
        description: 'Parse briefs only, no API calls (true/false)'
        required: false
        default: 'false'

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run pipeline
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL || 'gpt-4.1' }}
          EDITOR_MODEL: ${{ vars.EDITOR_MODEL || 'gpt-4.1' }}
        run: python run_pipeline.py ${{ github.event.inputs.week && format('--week {0}', github.event.inputs.week) || '' }} ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}
      - name: Commit output
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          git config user.name "Tarotsmith Pipeline"
          git config user.email "pipeline@tarotsmith.com"
          git add output/*.json || true
          git diff --cached --quiet || git commit -m "horoscopes: $(date +%Y-%m-%d)" && git push
